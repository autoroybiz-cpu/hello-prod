name: CI (lint & checks)

on:
push:
branches: [ "main" ]
pull_request:
branches: [ "main" ]
schedule:
- cron: "17 3 * * *" # פעם ביום

permissions:
contents: read

concurrency:
group: ci-${{ github.ref }}
cancel-in-progress: false

jobs:
prettier:
name: Prettier check
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4
- uses: actions/setup-node@v4
with:
node-version: 20
- name: Run Prettier (check only)
run: npx --yes prettier@3.3.3 --check "**/*.{html,css,js,md,yml,yaml}"

links:
name: Link check (README + HTML)
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4
- name: Lychee broken links
uses: lycheeverse/lychee-action@v1
with:
args: >
--no-progress
--max-concurrency 6
--retry-wait-time 2
--accept 200,206,301,302,429
**/*.md **/*.html
env:
GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

health:
name: Health endpoint
runs-on: ubuntu-latest
env:
SITE_URL: ${{ vars.SITE_URL }}
steps:
- name: Curl /healthz
shell: bash
run: |
URL="${SITE_URL:-https://hello-prod.onrender.com}/healthz"
echo "Checking $URL"
code=$(curl -s -o /tmp/body -w "%{http_code}" "$URL")
echo "Status: $code"
test "$code" = "200"
